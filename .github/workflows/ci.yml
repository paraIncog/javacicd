name: CI & Deploy (Docker Compose -> DigitalOcean)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  ci:
    name: CI (Gradle + Vue)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Backend CI (Gradle) ----
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Backend tests
        working-directory: backend
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      # ---- Frontend CI (Vue) ----
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

  build-and-push:
    name: Build & Push images to DO Registry
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Login to DO Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Build & push API image
        run: |
          docker build -t registry.digitalocean.com/${{ secrets.DO_REGISTRY }} ./backend
          docker push registry.digitalocean.com/${{ secrets.DO_REGISTRY }}

      - name: Build & push WEB image
        run: |
          docker build -t registry.digitalocean.com/${{ secrets.DO_REGISTRY }} ./frontend
          docker push registry.digitalocean.com/${{ secrets.DO_REGISTRY }}

  deploy:
    name: Deploy on Droplet
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: SSH deploy (docker compose pull/up)
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            cd /var/www/cicd_vue

            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d

            docker image prune -f
